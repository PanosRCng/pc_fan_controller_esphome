esphome:
  name: fan-controller
  friendly_name: fan_controller


  on_boot:
    then:
    - delay: !lambda "return 1000 *(rand() % 3);"
    - fan.turn_on:
        id: fan_toggle
    - output.set_level: 
        id: fan_speed
        level: 100%
    - delay: 5s
    - switch.turn_off: 
        id: override_swi


esp8266:
  board: nodemcu

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: "xxxxxxxxxxxxxx"

ota:
  - platform: esphome
    password: "xxxxxxxxxxxxxx"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  manual_ip:
    static_ip: xxx.xxx.xxx.xxx
    gateway: xxx.xxx.xxx.xxx
    subnet: xxx.xxx.xxx.xxx


one_wire:
  - platform: gpio
    pin: D6


sensor:

  - platform: wifi_signal
    name: fan WiFi Strength
    update_interval: 60s

  - platform: dallas_temp
    name: temperature
    update_interval: 60s
    id: temperature_id
    on_value:
      then:

        if:
          condition:
            - fan.is_on:
                id: fan_toggle
          then:

            if:
              condition:
                - switch.is_off:
                    id: override_swi
              then:

                -  if:
                    condition:
                      sensor.in_range:
                        id: temperature_id
                        below: 37
                    then:
                      - fan.turn_on:
                          id: fan_toggle
                      - output.set_level:
                          id: fan_speed
                          level: 25%
                      - output.turn_on:
                          blueLED
                      - output.set_level: 
                          id: blueLED
                          level: "25%"

                -  if:
                    condition:
                      sensor.in_range:
                        id: temperature_id
                        above: 37
                        below: 40
                    then:
                      - fan.turn_on:
                          id: fan_toggle
                      - output.set_level:
                          id: fan_speed
                          level: 50%
                      - output.turn_on:
                          blueLED
                      - output.set_level: 
                          id: blueLED
                          level: "50%"

                -  if:
                    condition:
                      sensor.in_range:
                        id: temperature_id
                        above: 40
                        below: 45
                    then:
                      - fan.turn_on:
                          id: fan_toggle
                      - output.set_level:
                          id: fan_speed
                          level: 75%
                      - output.turn_on:
                          blueLED
                      - output.set_level: 
                          id: blueLED
                          level: "75%"

                -  if:
                    condition:
                      sensor.in_range:
                        id: temperature_id
                        above: 45
                    then:
                      - fan.turn_on:
                          id: fan_toggle
                      - output.set_level:
                          id: fan_speed
                          level: 100%
                      - output.turn_on:
                          blueLED
                      - output.set_level: 
                          id: blueLED
                          level: "100%"


  - platform: adc
    id: source_sensor
    pin: A0
    update_interval: 1s
    filters:
      - multiply: 3.3
    on_value_range:
      - below: 0.1
        then:
          - fan.turn_off:
              id: fan_toggle
          - output.turn_off:
              id: blueLED
      - above: 0.1
        below: 0.8
        then:
          - switch.turn_off: 
              id: override_swi
      - above: 0.8
        below: 1.6
        then:
          - fan.turn_on:
              id: fan_toggle
          - output.set_level:
              id: fan_speed
              level: 25%
          - switch.turn_on: 
              id: redLED
          - output.turn_on:
              blueLED
          - output.set_level: 
              id: blueLED
              level: "25%"
          - number.set:
              id: fan_speed_override
              value: 25
          - switch.turn_on: 
              id: override_swi
      - above: 1.6
        below: 2.4
        then:
          - fan.turn_on:
              id: fan_toggle
          - output.set_level:
              id: fan_speed
              level: 50%
          - switch.turn_on: 
              id: redLED
          - output.turn_on:
              blueLED
          - output.set_level: 
              id: blueLED
              level: "50%"
          - number.set:
              id: fan_speed_override
              value: 50
          - switch.turn_on: 
              id: override_swi
      - above: 2.4
        below: 3.2
        then:
          - fan.turn_on:
              id: fan_toggle
          - output.set_level:
              id: fan_speed
              level: 75%
          - switch.turn_on: 
              id: redLED
          - output.turn_on:
              blueLED
          - output.set_level: 
              id: blueLED
              level: "75%"
          - number.set:
              id: fan_speed_override
              value: 75
          - switch.turn_on: 
              id: override_swi
      - above: 3.2
        then:
          - fan.turn_on:
              id: fan_toggle
          - output.set_level:
              id: fan_speed
              level: 100%
          - switch.turn_on: 
              id: redLED
          - output.turn_on:
              blueLED
          - output.set_level: 
              id: blueLED
              level: "100%"
          - number.set:
              id: fan_speed_override
              value: 100
          - switch.turn_on: 
              id: override_swi



output:

  - platform: esp8266_pwm
    id: fan_speed
    pin: D2                                                                                                                                                  
    frequency: "25000 Hz"                                                                                                                                                                     
    min_power: 0
    max_power: 1
    zero_means_zero: True

  - platform: gpio
    pin: D3
    id: fan_power

  - platform: slow_pwm
    pin: D8
    id: blueLED
    period: 1000ms



fan:

  - platform: speed
    output: fan_speed
    name: fan power switch
    id: fan_toggle
    on_turn_on:
      - output.turn_on: fan_power
      - output.set_level: 
          id: fan_speed
          level: 100%
      - output.turn_on:
          blueLED  
      - output.set_level:
          id: blueLED
          level: "100%"
    on_turn_off:
      - output.turn_off: fan_power
      - output.turn_off:
          id: blueLED
      - switch.turn_off:
          id: redLED



number:

  - platform: template
    name: "Fan Speed Override"
    id: fan_speed_override
    internal: false
    max_value: 100.0
    min_value: 25.0
    step: 25
    optimistic: true
    mode: slider
    on_value:
      then:
        if:
          condition:
            fan.is_on: fan_toggle
          then:
          - switch.turn_on: 
              id: override_swi
          - output.set_level:
              id: fan_speed
              level: !lambda "return x/100;"
          - switch.turn_on: 
              id: redLED
          - output.set_level: 
              id: blueLED
              level: !lambda "return x/100;"


switch:   
                                                                                                                                                                                              
  - platform: restart
    name: "Fan Restart"

  - platform: gpio
    pin:
      number: D7
      mode: output
    id: redLED

  - platform: template
    name: "override"
    id: override_swi
    optimistic: true
    turn_on_action:
      - switch.turn_on: 
          id: redLED
    turn_off_action:
      - switch.turn_off: 
          id: redLED
      - fan.turn_on:
          id: fan_toggle
      - output.set_level:
          id: fan_speed
          level: 25%
      - output.turn_on:
          blueLED
      - output.set_level: 
          id: blueLED
          level: "25%"
